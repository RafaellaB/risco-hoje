name: 游늵 2. C치lculo e Incremento de Risco (Di치rio 맙 23:59)

on:
  schedule:
    - cron: '59 2 * * *' # 23:59 em Recife (UTC-3)
  workflow_dispatch:

jobs:
  pipeline_risco_diario:
    runs-on: ubuntu-latest
    
    env:
      CEMADEN_EMAIL: ${{ secrets.CEMADEN_EMAIL }}
      CEMADEN_SENHA: ${{ secrets.CEMADEN_SENHA }}

    steps:
      - name: Checkout do Reposit칩rio de Origem
        uses: actions/checkout@v4
        
      - name: Configurar Python e Instalar depend칡ncias (Completo)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: pip install requests pandas pytz numpy 
        
      - name: 丘뙖잺 Executar 'calcular_risco_cli.py' (Calcula e incrementa o hist칩rico)
        run: python calcular_risco_cli.py
        
      # --- PASSO FINAL: ENVIO DE DADOS PARA REPOSIT칍RIO DE DESTINO (AUTENTICA칂츾O ROBUSTA) ---
      - name: 游 Enviar 'resultado_risco_final.csv' para o Reposit칩rio do Painel
        run: |
          DEST_REPO="RafaellaB/Painel-Diagrama-de-Risco"
          DEST_BRANCH="main"
          DEST_DIR="destino_repo"
          
          # 1. Configura a identifica칞칚o do bot
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # 2. Constr칩i a URL do reposit칩rio com o Token de Acesso Pessoal (PAT)
          # Isso 칠 a maneira mais garantida de passar a credencial.
          REPO_URL="https://${{ secrets.REPO_DESTINO_TOKEN }}@github.com/${DEST_REPO}.git"
          
          # 3. Clona o reposit칩rio de destino usando a URL autenticada
          git clone --single-branch --branch ${DEST_BRANCH} ${REPO_URL} ${DEST_DIR}
          cd ${DEST_DIR}

          # 4. Copia o arquivo gerado da raiz
          cp ../resultado_risco_final.csv .

          # 5. Faz o commit e push
          git add resultado_risco_final.csv
          
          # O commit falha sem que o job quebre se n칚o houver altera칞칚o
          git commit -m "Incremento di치rio de risco: Adicionado dado do dia que encerrou." || exit 0
          
          # Envia para o reposit칩rio de destino (o token est치 na URL de origem)
          git push origin ${DEST_BRANCH}
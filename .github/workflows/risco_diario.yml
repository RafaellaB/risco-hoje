name: 游늵 2. C치lculo e Incremento de Risco (Di치rio 맙 23:59)

on:
  schedule:
    - cron: '59 2 * * *' # 23:59 em Recife (UTC-3)
  workflow_dispatch:

jobs:
  pipeline_risco_diario:
    runs-on: ubuntu-latest
    
    env:
      CEMADEN_EMAIL: ${{ secrets.CEMADEN_EMAIL }}
      CEMADEN_SENHA: ${{ secrets.CEMADEN_SENHA }}

    steps:
      - name: Checkout do Reposit칩rio de Origem
        uses: actions/checkout@v4
        
      - name: Configurar Python e Instalar depend칡ncias (Completo)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: pip install requests pandas pytz numpy 
        
      - name: 丘뙖잺 Executar 'calcular_risco_cli.py' (Calcula e incrementa o hist칩rico)
        run: python calcular_risco_cli.py
        
      # --- PASSO 3: ENVIO DE DADOS PARA REPOSIT칍RIO DE DESTINO (CORRE칂츾O DE AUTENTICA칂츾O) ---
      - name: 游 Enviar 'resultado_risco_final.csv' para o Reposit칩rio do Painel
        run: |
          # Configura as credenciais globais para o Git usar o Token para o dom칤nio do GitHub
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          DEST_REPO="RafaellaB/Painel-Diagrama-de-Risco"
          DEST_BRANCH="main"
          DEST_DIR="destino_repo"
          
          # ** LINHA CHAVE DE AUTENTICA칂츾O **: Injeta o token para uso em qualquer URL do GitHub.
          git config --global url."https://${{ secrets.REPO_DESTINO_TOKEN }}@github.com/".insteadOf "https://github.com/"

          # Clona o reposit칩rio de destino usando a configura칞칚o de autentica칞칚o
          git clone --single-branch --branch ${DEST_BRANCH} https://github.com/${DEST_REPO}.git ${DEST_DIR}
          cd ${DEST_DIR}

          # Copia o arquivo gerado da raiz do reposit칩rio de origem para o reposit칩rio clonado
          cp ../resultado_risco_final.csv .

          # Faz o commit e push
          git add resultado_risco_final.csv
          
          # Se n칚o houver altera칞칚o (para o caso de o script ter rodado mais de uma vez com o mesmo dado), ele n칚o falha.
          git commit -m "Incremento di치rio de risco: Adicionado dado do dia que encerrou." || exit 0
          
          # O push usa o token configurado globalmente
          git push origin ${DEST_BRANCH}